<!doctype html><html lang=en-us><head><meta charset=utf-8><meta name=generator content="Hugo 0.101.0"><meta name=viewport content="width=device-width,initial-scale=1"><title>Tutorial: Command-Line Uploader &#183; Go Development Kit</title><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Source+Code+Pro|Work+Sans:400,700"><link type=text/css rel=stylesheet href=/css/syntax.css><link type=text/css rel=stylesheet href=/css/style.css><link rel="shortcut icon" href=/favicon-32x32.png></head><body><div class=PageLayout><header class=PageHeader><a href=https://gocloud.dev/><h1 class=PageLogo><img class=PageLogo-image src=/go-cdk-logo-white.png alt="Go Development Kit"></h1></a></header><main class=MainContent><div class=MainContent-bounds><h1>Tutorial: Command-Line Uploader</h1><p>This quickstart will build a command line application called <code>upload</code> that
uploads files to blob storage on GCP, AWS, and Azure. Blob storage stores binary
data under a string key, and is one of the most frequently used cloud
services.</p><p>When we&rsquo;re done, our command line application will work like this:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=c1># uploads gopher.png to GCS</span>
</span></span><span class=line><span class=cl>$ ./upload gs://go-cloud-bucket gopher.png
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># uploads gopher.png to S3</span>
</span></span><span class=line><span class=cl>$ ./upload s3://go-cloud-bucket gopher.png
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># uploads gopher.png to Azure</span>
</span></span><span class=line><span class=cl>$ ./upload azblob://go-cloud-bucket gopher.png
</span></span></code></pre></div><p>(You can download the finished tutorial <a href=https://github.com/sraphs/gdk/tree/master/samples/tutorial/>from GitHub</a>).</p><h2 id=setup>Setup<a class=anchor href=#setup aria-label="Link to Section">ðŸ”—</a></h2><p>We start with a skeleton for our program to read from command-line
arguments to configure the bucket URL.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// Command upload saves files to blob storage on GCP, AWS, and Azure.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kn>package</span> <span class=nx>main</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;log&#34;</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;os&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// Define our input.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=nx>os</span><span class=p>.</span><span class=nx>Args</span><span class=p>)</span> <span class=o>!=</span> <span class=mi>3</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>log</span><span class=p>.</span><span class=nf>Fatal</span><span class=p>(</span><span class=s>&#34;usage: upload BUCKET_URL FILE&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=nx>bucketURL</span> <span class=o>:=</span> <span class=nx>os</span><span class=p>.</span><span class=nx>Args</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=nx>file</span> <span class=o>:=</span> <span class=nx>os</span><span class=p>.</span><span class=nx>Args</span><span class=p>[</span><span class=mi>2</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=nx>_</span><span class=p>,</span> <span class=nx>_</span> <span class=p>=</span> <span class=nx>bucketURL</span><span class=p>,</span> <span class=nx>file</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>Now that we have a basic skeleton in place, let&rsquo;s start filling in the pieces.</p><h2 id=connecting-to-the-bucket>Connecting to the bucket<a class=anchor href=#connecting-to-the-bucket aria-label="Link to Section">ðŸ”—</a></h2><p>The easiest way to open a portable bucket API is with <code>blob.OpenBucket</code>.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>package</span> <span class=nx>main</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=c1>// previous imports omitted
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;github.com/sraphs/gdk/blob&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// previous code omitted
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>    <span class=c1>// Open a connection to the bucket.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>b</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>blob</span><span class=p>.</span><span class=nf>OpenBucket</span><span class=p>(</span><span class=nx>context</span><span class=p>.</span><span class=nf>Background</span><span class=p>(),</span> <span class=nx>bucketURL</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>log</span><span class=p>.</span><span class=nf>Fatalf</span><span class=p>(</span><span class=s>&#34;Failed to setup bucket: %s&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>defer</span> <span class=nx>b</span><span class=p>.</span><span class=nf>Close</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>This is all we need in the <code>main</code> function to connect to the bucket. However,
as written, this function call will always fail: the Go CDK does not link in any
cloud-specific implementations of <code>blob.OpenBucket</code> unless you specifically
depend on them. This ensures you&rsquo;re only depending on the code you need.
To link in implementations, use blank imports:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>package</span> <span class=nx>main</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=c1>// previous imports omitted
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>    <span class=c1>// Import the blob packages we want to be able to open.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>_</span> <span class=s>&#34;github.com/sraphs/gdk/blob/azureblob&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nx>_</span> <span class=s>&#34;github.com/sraphs/gdk/blob/gcsblob&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nx>_</span> <span class=s>&#34;github.com/sraphs/gdk/blob/s3blob&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// ...
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span>
</span></span></code></pre></div><p>With the setup done, we&rsquo;re ready to use the bucket connection. Note, as a design
principle of the Go CDK, <code>blob.Bucket</code> does not support creating a bucket and
instead focuses solely on interacting with it. This separates the concerns of
provisioning infrastructure and using infrastructure.</p><h2 id=reading-the-file>Reading the file<a class=anchor href=#reading-the-file aria-label="Link to Section">ðŸ”—</a></h2><p>We need to read our file into a slice of bytes before uploading it. The process
is the usual one:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>package</span> <span class=nx>main</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=c1>// previous imports omitted
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=s>&#34;os&#34;</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;io/ioutil&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// ... previous code omitted
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>    <span class=c1>// Prepare the file for upload.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>data</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>ioutil</span><span class=p>.</span><span class=nf>ReadFile</span><span class=p>(</span><span class=nx>file</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>log</span><span class=p>.</span><span class=nf>Fatalf</span><span class=p>(</span><span class=s>&#34;Failed to read file: %s&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h2 id=writing-the-file-to-the-bucket>Writing the file to the bucket<a class=anchor href=#writing-the-file-to-the-bucket aria-label="Link to Section">ðŸ”—</a></h2><p>Now, we have <code>data</code>, our file in a slice of bytes. Let&rsquo;s get to the fun part and
write those bytes to the bucket!</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>package</span> <span class=nx>main</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// No new imports.
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// ...
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>    <span class=nx>w</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>b</span><span class=p>.</span><span class=nf>NewWriter</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=nx>file</span><span class=p>,</span> <span class=kc>nil</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>log</span><span class=p>.</span><span class=nf>Fatalf</span><span class=p>(</span><span class=s>&#34;Failed to obtain writer: %s&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=nx>_</span><span class=p>,</span> <span class=nx>err</span> <span class=p>=</span> <span class=nx>w</span><span class=p>.</span><span class=nf>Write</span><span class=p>(</span><span class=nx>data</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>log</span><span class=p>.</span><span class=nf>Fatalf</span><span class=p>(</span><span class=s>&#34;Failed to write to bucket: %s&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>w</span><span class=p>.</span><span class=nf>Close</span><span class=p>();</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>log</span><span class=p>.</span><span class=nf>Fatalf</span><span class=p>(</span><span class=s>&#34;Failed to close: %s&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>First, we create a writer based on the bucket connection. In addition to a
<code>context.Context</code> type, the method takes the key under which the data will be
stored and the mime type of the data.</p><p>The call to <code>NewWriter</code> creates a <code>blob.Writer</code>, which implements <code>io.Writer</code>.
With the writer, we call <code>Write</code> passing in the data. In response, we get the
number of bytes written and any error that might have occurred.</p><p>Finally, we close the writer with <code>Close</code> and check the error.</p><p>Alternatively, we could have used the shortcut <code>b.WriteAll(ctx, file, data, nil)</code>.</p><h2 id=uploading-an-image>Uploading an image<a class=anchor href=#uploading-an-image aria-label="Link to Section">ðŸ”—</a></h2><p>That&rsquo;s it! Let&rsquo;s try it out. As setup, we will need to create a
<a href=https://cloud.google.com/storage/docs/creating-buckets>GCS bucket</a>, an <a href=https://docs.aws.amazon.com/AmazonS3/latest/gsg/CreatingABucket.html>S3 bucket</a>, and an
<a href=https://docs.microsoft.com/en-us/azure/storage/blobs/storage-blobs-introduction>Azure container</a>. In the code above, I called that bucket
<code>go-cloud-bucket</code>, but you can change that to match whatever your bucket is
called. Of course, you are free to try the code on any subset of Cloud
providers.</p><ul><li>For GCP, you will need to login with
<a href=https://cloud.google.com/sdk/install>gcloud</a>. If you do not want to
install <code>gcloud</code>, see
<a href=https://cloud.google.com/docs/authentication/production>here</a> for
alternatives.</li><li>For AWS, you will need an access key ID and a secret access key. See
<a href=https://docs.aws.amazon.com/IAM/latest/UserGuide/id_credentials_access-keys.html#Using_CreateAccessKey>here</a>
for details. You then need to set the <code>AWS_REGION</code> environment variable to
the region your bucket is in.</li><li>For Azure, you will need to add your storage account name and key as
environment variables (<code>AZURE_STORAGE_ACCOUNT</code> and
<code>AZURE_STORAGE_KEY</code>, respectively). See
<a href=https://docs.microsoft.com/en-us/azure/storage/blobs/storage-quickstart-blobs-portal>here</a>
for details.</li></ul><p>With our buckets created and our credentials set up, we&rsquo;ll build the program
first:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ go build -o upload
</span></span></code></pre></div><p>Then, we will send <code>gopher.png</code> (in the same directory as this README) to GCS:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ ./upload gs://go-cloud-bucket gopher.png
</span></span></code></pre></div><p>Then, we send that same gopher to S3:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ ./upload s3://go-cloud-bucket?region<span class=o>=</span>us-west-1 gopher.png
</span></span></code></pre></div><p>Finally, we send that same gopher to Azure:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ ./upload azblob://go-cloud-bucket gopher.png
</span></span></code></pre></div><p>If we check the buckets, we should see our gopher in each of them! We&rsquo;re done!</p><h2 id=wrapping-up>Wrapping Up<a class=anchor href=#wrapping-up aria-label="Link to Section">ðŸ”—</a></h2><p>In conclusion, we have a program that can seamlessly switch between multiple
Cloud storage providers using just one code path. You can see the finished
tutorial <a href=https://github.com/sraphs/gdk/tree/master/samples/tutorial/>on GitHub</a>.</p><p>We hope this example demonstrates how having one type for multiple clouds is a
huge win for simplicity and maintainability. By writing an application using a
generic interface like <code>*blob.Bucket</code>, we retain the option of using
infrastructure in whichever cloud that best fits our needs all without having to
worry about a rewrite. If you want to learn more, you can read about
<a href=https://gocloud.dev/concepts/structure/>Structuring Portable Code</a>.</p><p>If you want to see how to deploy a Go CDK application, see <a href=https://gocloud.dev/tutorials/>other tutorials</a>.
If you want to see how to use Go CDK APIs in your application, see the
<a href=https://gocloud.dev/howto/>how-to guides</a>.</p></div></main><nav class=Sidenav><ul class=Sidenav-list><li class=Sidenav-section><a href=/ class=Sidenav-sectionLink>Home</a></li><li class=Sidenav-section><a href=/tutorials/ class=Sidenav-sectionLink>Tutorials</a><ul class=Sidenav-pageList><li class=Sidenav-page><a href=/tutorials/cli-uploader/ class=Sidenav-pageLink>Command-Line Uploader</a></li><li class=Sidenav-page><a href=/tutorials/guestbook/ class=Sidenav-pageLink>Guestbook</a></li><li class=Sidenav-page><a href=/tutorials/order/ class=Sidenav-pageLink>Order Processor</a></li></ul></li><li class=Sidenav-section><a href=/howto/ class=Sidenav-sectionLink>How-To Guides</a><ul class=Sidenav-pageList><li class=Sidenav-page><a href=/howto/blob/ class=Sidenav-pageLink>Blob</a></li><li class=Sidenav-page><a href=/howto/pubsub/ class=Sidenav-pageLink>Pub/Sub</a></li><li class=Sidenav-page><a href=/howto/runtimevar/ class=Sidenav-pageLink>Runtime Configuration</a></li><li class=Sidenav-page><a href=/howto/secrets/ class=Sidenav-pageLink>Secrets</a></li></ul></li><li class=Sidenav-section><a href=/concepts/ class=Sidenav-sectionLink>Concepts</a><ul class=Sidenav-pageList><li class=Sidenav-page><a href=/concepts/structure/ class=Sidenav-pageLink>Structuring Portable Code</a></li><li class=Sidenav-page><a href=/concepts/urls/ class=Sidenav-pageLink>URLs</a></li><li class=Sidenav-page><a href=/concepts/as/ class=Sidenav-pageLink>Using provider-specific APIs</a></li></ul></li></ul></nav><footer class=PageFooter><nav><ul class=FooterLinks><li class=FooterLinks-item><a href=https://github.com/sraphs/gdk/ class=FooterLinks-link>GitHub</a></li><li class=FooterLinks-item><a href=https://github.com/sraphs/gdk/issues class=FooterLinks-link>Contact Team</a></li></ul></nav><p class=PageFooter-paragraph>Copyright Â© 2022-2022 The Go Development Kit Authors.
All content released under an <a href=https://github.com/sraphs/gdk/main/LICENSE target=_blank class=PageFooter-link>Apache 2.0 License</a>.</p><p class=PageFooter-paragraph><a href=https://github.com/sraphs/gdk/main/internal/website/content/tutorials/cli-uploader.md class=PageFooter-link>Improve this page</a> on GitHub.</p></footer></div></body></html>