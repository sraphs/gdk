<!doctype html><html lang=en-us><head><meta charset=utf-8><meta name=generator content="Hugo 0.101.0"><meta name=viewport content="width=device-width,initial-scale=1"><title>Structuring Portable Code &#183; Go Development Kit</title><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Source+Code+Pro|Work+Sans:400,700"><link type=text/css rel=stylesheet href=../../css/syntax.css><link type=text/css rel=stylesheet href=../../css/style.css><link rel="shortcut icon" href=../../favicon-32x32.png></head><body><div class=PageLayout><header class=PageHeader><a href><h1 class=PageLogo><img class=PageLogo-image src=../../go-cdk-logo-white.png alt="Go Development Kit"></h1></a></header><main class=MainContent><div class=MainContent-bounds><h1>Structuring Portable Code</h1><p>The Go CDK&rsquo;s APIs are intentionally structured to make it easier to separate
your application&rsquo;s core logic from the details of the services it is using.</p><h2 id=motivation>Motivation<a class=anchor href=#motivation aria-label="Link to Section">ðŸ”—</a></h2><p>Consider the <a href=../../tutorials/cli-uploader/>uploader tutorial</a>. Without the Go CDK, we would have had to
write a code path for Amazon&rsquo;s Simple Storage Service (S3) and another code
path for Google Cloud Storage (GCS). That would work, but it would be
tedious. We would have to learn the semantics of uploading files to both blob
storage services. Even worse, we would have two code paths that effectively
do the same thing, but would have to be maintained separately. It would be
much nicer if we could write the upload logic once and reuse it across
providers. That&rsquo;s exactly the kind of <a href=https://en.wikipedia.org/wiki/Separation_of_concerns>separation of concerns</a> that the Go
CDK makes possible.</p><p>(More details available in the <a href=https://github.com/sraphs/gdk/blob/master/internal/docs/design.md#developers-and-operators>Go CDK design doc</a>.)</p><h2 id=portable-types-and-drivers>Portable Types and Drivers<a class=anchor href=#portable-types-and-drivers aria-label="Link to Section">ðŸ”—</a></h2><p>The portable APIs that the Go CDK exports (like <a href=https://godoc.org/github.com/sraphs/gdk/blob#Bucket><code>blob.Bucket</code></a> or
<a href=https://godoc.org/github.com/sraphs/gdk/runtimevar#Variable><code>runtimevar.Variable</code></a>) are concrete types, not interfaces. To understand
why, imagine if we used a plain interface:</p><figure class=FullWidthFigure><a href=portable-type-no-driver.png><img src=portable-type-no-driver.png alt="Diagram showing user code depending on blob.Bucket, which is implemented by awsblob.Bucket."></a></figure><p>Consider the <a href=https://godoc.org/github.com/sraphs/gdk/blob#Bucket.NewWriter><code>Bucket.NewWriter</code> method</a>, which infers the content type of the
blob based on the first bytes written to it. If <code>blob.Bucket</code> was an interface,
each implementation of <code>blob.Bucket</code> would have to replicate this behavior
precisely. This does not scale: conformance tests would be needed to ensure that
each interface method actually behaves in the way that the docs describe. This
makes the interfaces hard to implement, which runs counter to the goals of the
project.</p><p>Instead, we follow the example of <a href=https://godoc.org/database/sql><code>database/sql</code></a> and separate out the
implementation-agnostic logic from the interface. The implementation-agnostic
logic-containing concrete type is the <strong>portable type</strong>. We call the interface
the <strong>driver</strong>. Visually, it looks like this:</p><figure class=FullWidthFigure><a href=portable-type.png><img src=portable-type.png alt="Diagram showing user code depending on blob.Bucket, which holds a driver.Bucket implemented by awsblob.Bucket."></a></figure><p>This has a number of benefits:</p><ul><li>The portable type can perform higher level logic without making the
interface complex to implement. In the blob example, the portable type&rsquo;s
<code>NewWriter</code> method can do the content type detection and then pass the final
result to the driver type.</li><li>Methods can be added to the portable type without breaking compatibility.
Contrast with adding methods to an interface, which is a breaking change.</li><li>When new operations on the driver are added as new optional interfaces, the
portable type can hide the need for type-assertions from the user.</li></ul><p>(More details available in the <a href=https://github.com/sraphs/gdk/blob/master/internal/docs/design.md#portable-types-and-drivers>Go CDK design doc</a>.)</p><h2 id=best-practices>Best Practices<a class=anchor href=#best-practices aria-label="Link to Section">ðŸ”—</a></h2><ul><li><strong>Create portable types as close to program startup as possible.</strong> Since
creation of a portable type requires using driver-specific setup, this
separates your driver-specific details from the rest of your application.</li><li><strong>Pass portable types around as arguments or struct fields instead of as
package variables.</strong> This allows you to easily swap out the portable type
for a local implementation in unit tests. It also enables you to use
dependency injection tools like <a href=https://github.com/google/wire>Wire</a> to set up your application.</li><li><strong>Avoid using <a href=../../concepts/as/#as><code>As</code></a> functions when possible.</strong> Using driver-specific
options makes it harder to test your code with confidence or migrate to
another driver later. If your application needs to use driver-specific
options, try to make it so that other drivers fall back gracefully. For
example, you may need to use a particular ACL setting for a write to a Google
Cloud Storage bucket. When testing for the driver-specific write options,
don&rsquo;t return an error if the <code>As</code> function doesn&rsquo;t have the right type. That
way, when running against an in-memory bucket for tests, the write will still
occur and can be observed. Leave provider-specific checks to integration
tests.</li></ul></div></main><nav class=Sidenav><ul class=Sidenav-list><li class=Sidenav-section><a href=../../ class=Sidenav-sectionLink>Home</a></li><li class=Sidenav-section><a href=../../tutorials/ class=Sidenav-sectionLink>Tutorials</a><ul class=Sidenav-pageList><li class=Sidenav-page><a href=../../tutorials/cli-uploader/ class=Sidenav-pageLink>Command-Line Uploader</a></li><li class=Sidenav-page><a href=../../tutorials/guestbook/ class=Sidenav-pageLink>Guestbook</a></li><li class=Sidenav-page><a href=../../tutorials/order/ class=Sidenav-pageLink>Order Processor</a></li></ul></li><li class=Sidenav-section><a href=../../howto/ class=Sidenav-sectionLink>How-To Guides</a><ul class=Sidenav-pageList><li class=Sidenav-page><a href=../../howto/blob/ class=Sidenav-pageLink>Blob</a></li><li class=Sidenav-page><a href=../../howto/pubsub/ class=Sidenav-pageLink>Pub/Sub</a></li><li class=Sidenav-page><a href=../../howto/runtimevar/ class=Sidenav-pageLink>Runtime Configuration</a></li><li class=Sidenav-page><a href=../../howto/secrets/ class=Sidenav-pageLink>Secrets</a></li></ul></li><li class=Sidenav-section><a href=../../concepts/ class=Sidenav-sectionLink>Concepts</a><ul class=Sidenav-pageList><li class=Sidenav-page><a href=../../concepts/structure/ class=Sidenav-pageLink>Structuring Portable Code</a></li><li class=Sidenav-page><a href=../../concepts/urls/ class=Sidenav-pageLink>URLs</a></li><li class=Sidenav-page><a href=../../concepts/as/ class=Sidenav-pageLink>Using provider-specific APIs</a></li></ul></li></ul></nav><footer class=PageFooter><nav><ul class=FooterLinks><li class=FooterLinks-item><a href=https://github.com/sraphs/gdk/ class=FooterLinks-link>GitHub</a></li><li class=FooterLinks-item><a href=https://github.com/sraphs/gdk/issues class=FooterLinks-link>Contact Team</a></li></ul></nav><p class=PageFooter-paragraph>Copyright Â© 2022-2022 The Go Development Kit Authors.
All content released under an <a href=https://github.com/sraphs/gdk/main/LICENSE target=_blank class=PageFooter-link>Apache 2.0 License</a>.</p><p class=PageFooter-paragraph><a href=https://github.com/sraphs/gdk/main/internal/website/content/concepts/structure/index.md class=PageFooter-link>Improve this page</a> on GitHub.</p></footer></div></body></html>